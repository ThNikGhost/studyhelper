# Архитектурные решения

## Дата создания: 2026-02-03

---

## 1. Выбор фреймворков

### Frontend: React + TypeScript + Vite

**Решение:** Использовать React с TypeScript и сборщиком Vite.

**Обоснование:**
- Vite обеспечивает быструю сборку и HMR (Hot Module Replacement)
- React — самая популярная библиотека с огромным сообществом
- TypeScript даёт типобезопасность и улучшает DX
- Отличная поддержка PWA через vite-plugin-pwa
- shadcn/ui предоставляет качественные компоненты с возможностью кастомизации

**Альтернативы рассмотренные:**
- Next.js — избыточен для PWA без SSR
- Vue.js — меньше готовых решений для PWA
- Svelte — меньше сообщество, сложнее найти решения

### Backend: Python + FastAPI

**Решение:** Использовать FastAPI как основной фреймворк.

**Обоснование:**
- Асинхронный из коробки — важно для парсинга и уведомлений
- Автоматическая генерация OpenAPI документации
- Встроенная валидация через Pydantic
- Высокая производительность
- Простота написания и поддержки кода

**Альтернативы рассмотренные:**
- Django — избыточен, Django REST Framework тяжеловесен
- Flask — нет async из коробки, больше бойлерплейта

### База данных: PostgreSQL

**Решение:** PostgreSQL как основная СУБД.

**Обоснование:**
- Надёжность и производительность
- Поддержка JSON для гибких структур данных
- Хорошая интеграция с SQLAlchemy
- Бесплатная и open-source

---

## 2. Архитектурные решения

### Структура API

**Решение:** RESTful API с версионированием.

```
/api/v1/auth/*
/api/v1/schedule/*
/api/v1/subjects/*
/api/v1/works/*
...
```

**Обоснование:**
- Простота и понятность
- Версионирование позволяет безболезненно обновлять API
- Стандартные HTTP методы (GET, POST, PUT, DELETE)

### Аутентификация: JWT

**Решение:** JWT токены с access (15 мин) и refresh (7 дней).

**Обоснование:**
- Stateless — не требует хранения сессий на сервере
- Хорошо подходит для PWA
- Простая реализация с python-jose

### Парный режим

**Решение:** Оба пользователя имеют доступ ко всем данным, но:
- Общие данные (subjects, works, teachers) — редактируют оба
- Персональные данные (WorkStatus, Attendance) — только владелец

**Обоснование:**
- Минимизация дублирования данных
- Возможность видеть прогресс партнёра
- Чёткое разделение ответственности

### Парсинг расписания

**Решение:** Playwright для парсинга, Celery для фоновых задач.

**Обоснование:**
- Сайт ОмГУ использует JavaScript для рендеринга
- Playwright умеет работать с SPA
- Celery позволяет запускать парсинг по расписанию (cron)
- Хеширование расписания для определения изменений

---

## 3. Структура базы данных

### Ключевые таблицы

```
users              — пользователи (макс 2)
semesters          — семестры
subjects           — предметы (привязка к семестру)
schedule_entries   — записи расписания
schedule_snapshots — снапшоты для отслеживания изменений
works              — учебные работы
work_statuses      — статусы работ (per user)
work_status_history — история изменений статусов
teachers           — преподаватели
attendance         — посещаемость (per user)
departments        — подразделения универа
buildings          — корпуса
classmates         — одногруппники
files              — файлы
push_subscriptions — подписки на push
notification_settings — настройки уведомлений
```

### Связи
- `subjects` → `semesters` (many-to-one)
- `works` → `subjects` (many-to-one)
- `work_statuses` → `works`, `users` (many-to-one)
- `schedule_entries` → `subjects`, `teachers` (many-to-one, nullable)
- `attendance` → `users`, `schedule_entries` (many-to-one)
- `files` → `subjects`, `users` (many-to-one)

---

## 4. Принципы разработки

### Код
- Type hints обязательны (Python, TypeScript)
- Docstrings в формате Google (Python)
- Компоненты — функциональные (React)
- Атомарные коммиты с conventional commits

### Тестирование
- Unit-тесты для бизнес-логики
- Integration-тесты для API
- Минимальное покрытие: 80%

### Безопасность
- Никаких секретов в коде
- Валидация всех входных данных (Pydantic)
- HTTPS в продакшене
- Защита от CSRF, XSS

---

## 5. PWA требования

- Service Worker для offline-режима
- Web App Manifest
- Push-уведомления (Web Push API)
- Установка на домашний экран
- Кеширование статики и API-ответов

---

---

## 6. Windows-специфичные решения

### PostgreSQL: локальная установка вместо Docker

**Решение:** На Windows использовать локально установленный PostgreSQL вместо Docker.

**Обоснование:**
- asyncpg (асинхронный драйвер PostgreSQL для Python) имеет критические проблемы на Windows при подключении к PostgreSQL в Docker:
  - `ConnectionResetError` из-за `ProactorEventLoop` (дефолтный event loop на Windows)
  - Проблемы с кодировкой сообщений об ошибках (cp1251 vs UTF-8)
- Альтернативные драйверы (psycopg, psycopg_async, aiopg) либо не поддерживаются в SQLAlchemy 2.0 async, либо имеют те же проблемы с кодировкой
- Локальный PostgreSQL работает стабильно с asyncpg

**Альтернативы рассмотренные:**
- `WindowsSelectorEventLoopPolicy` — не помогло
- Драйвер `psycopg` вместо `asyncpg` — проблемы с кодировкой и аутентификацией
- Драйвер `aiopg` — не поддерживается в SQLAlchemy 2.0 async mode
- WSL2 — избыточно для данного проекта

### Vite: явное указание host

**Решение:** В `vite.config.ts` явно указывать `host: '127.0.0.1'`.

**Обоснование:**
- На Windows `localhost` может резолвиться в IPv6 (`::1`), а Vite по умолчанию слушает только IPv4
- Явное указание `127.0.0.1` гарантирует работу на всех Windows-машинах

---

## 7. Frontend решения

### Tailwind CSS v4

**Решение:** Использовать Tailwind CSS v4 с новым синтаксисом `@theme`.

**Обоснование:**
- Tailwind v4 использует новый подход к конфигурации через CSS `@theme` директиву
- Старый синтаксис с `@layer base` и CSS-переменными не работает
- `@apply` для кастомных классов типа `border-border` не поддерживается — нужно использовать прямые CSS-свойства

### Регистрация: двухэтапный процесс

**Решение:** После успешной регистрации автоматически выполнять логин.

**Обоснование:**
- Backend `/auth/register` возвращает `UserResponse`, а не токены
- Для получения JWT токенов необходимо вызвать `/auth/login`
- Улучшает UX — пользователю не нужно вводить данные повторно

---

## История изменений

| Дата | Решение | Причина |
|------|---------|---------|
| 2026-02-03 | Создан документ | Инициализация проекта |
| 2026-02-04 | PostgreSQL локально на Windows | asyncpg + Docker несовместимы на Windows |
| 2026-02-04 | Vite host: 127.0.0.1 | IPv6/IPv4 проблемы на Windows |
| 2026-02-04 | Tailwind v4 @theme синтаксис | Новая версия требует новый подход |
| 2026-02-04 | Автологин после регистрации | Backend не возвращает токены при регистрации |
